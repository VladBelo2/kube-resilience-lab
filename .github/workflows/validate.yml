name: üß™ Validate Kube Resilience Lab

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-vagrant-lab:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: üì• Checkout Repo
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Install VirtualBox
      run: |
        sudo apt-get update
        sudo apt-get install -y virtualbox

    - name: ‚öôÔ∏è Install Vagrant (via HashiCorp .deb)
      run: |
        curl -O https://releases.hashicorp.com/vagrant/2.4.1/vagrant_2.4.1-1_amd64.deb
        sudo apt install ./vagrant_2.4.1-1_amd64.deb

    - name: üöÄ Start Lab VM (headless)
      run: |
        vagrant up --no-provision
        vagrant provision

    - name: ‚úÖ Check Pod Health via Python
      run: vagrant ssh -c 'python3 /home/vagrant/check_health.py'
      
    - name: üì° Check Prometheus Targets
      run: |
        echo "[INFO] Waiting for Prometheus targets to become available..."

        for i in {1..10}; do
          vagrant ssh -c '
            curl -s -o /tmp/targets.json -w "HTTP: %{http_code}\n" http://localhost:9090/api/v1/targets
          ' > curl_output.txt 2>&1

          if grep -q "HTTP: 200" curl_output.txt; then
            echo "[OK] Prometheus responded."
            if vagrant ssh -c "grep -q '\"health\":\"up\"' /tmp/targets.json"; then
              echo "‚úÖ Prometheus has active targets"
              break
            else
              echo "[WAIT] Prometheus up, but targets not ready yet (attempt $i/10)"
            fi
          else
            echo "[WAIT] Prometheus not reachable yet (attempt $i/10)"
          fi

          sleep 10
        done

        echo "[INFO] Final Prometheus target dump:"
        vagrant ssh -c 'cat /tmp/targets.json || echo "No targets.json found."'

        if ! vagrant ssh -c "grep -q '\"health\":\"up\"' /tmp/targets.json"; then
          echo "‚ùå Prometheus targets not healthy."
          exit 1
        fi

    - name: üß™ Optional Curl App URLs
      run: |
        vagrant ssh -c '
          curl -s -o /dev/null -w "%{http_code}" http://microfail.kube-lab.local | grep 200
        '
