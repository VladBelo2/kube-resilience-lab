name: 🧪 Validate Kube Resilience Lab

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-vagrant-lab:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: 📥 Checkout Repo
      uses: actions/checkout@v4

    - name: ⚙️ Install VirtualBox
      run: |
        sudo apt-get update
        sudo apt-get install -y virtualbox

    - name: ⚙️ Install Vagrant (via HashiCorp .deb)
      run: |
        curl -O https://releases.hashicorp.com/vagrant/2.4.1/vagrant_2.4.1-1_amd64.deb
        sudo apt install ./vagrant_2.4.1-1_amd64.deb

    - name: 🚀 Start Lab VM (headless)
      run: |
        vagrant up --no-provision
        vagrant provision

    - name: ✅ Check Pod Readiness
      run: |
        echo "[INFO] Waiting for all pods to be Ready..."
        for i in {1..20}; do
          if vagrant ssh -c "kubectl get pods -A | grep -v 'Running\|Completed\|Ready'" | grep -q .; then
            echo "[WAIT] Some pods still not ready... retry $i/20"
            sleep 15
          else
            echo "✅ All pods ready!"
            exit 0
          fi
        done
        echo "❌ Pods failed to become Ready in time"
        exit 1

    - name: 📡 Check Prometheus Targets
      run: |
        vagrant ssh -c '
          curl -s http://localhost:9090/api/v1/targets | grep "up"
        '

    - name: 🧪 Optional Curl App URLs
      run: |
        vagrant ssh -c '
          curl -s -o /dev/null -w "%{http_code}" http://microfail.kube-lab.local | grep 200
        '
