name: 🧪 Validate Kube Resilience Lab

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-vagrant-lab:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: 📥 Checkout Repo
      uses: actions/checkout@v4

    - name: ⚙️ Install VirtualBox & jq
      run: |
        sudo apt-get update
        sudo apt-get install -y virtualbox jq

    - name: ⚙️ Install Vagrant (via HashiCorp .deb)
      run: |
        curl -O https://releases.hashicorp.com/vagrant/2.4.1/vagrant_2.4.1-1_amd64.deb
        sudo apt install ./vagrant_2.4.1-1_amd64.deb

    - name: 🚀 Start Lab VM (headless)
      run: |
        vagrant up --no-provision
        vagrant provision

    - name: ✅ Check Pod Readiness
      run: |
        echo "[INFO] Waiting for all pods to be Ready..."
        for i in {1..20}; do
          UNREADY_COUNT=$(vagrant ssh -c "
            kubectl get pods -A -o json |
            jq '[.items[] | select(
              .status.phase == \"Running\" and
              (.status.containerStatuses[]?.ready != true)
            )] | length'
          ")
          echo "[CHECK] Unready pods: $UNREADY_COUNT (attempt $i/20)"
          if [ \"$UNREADY_COUNT\" -eq 0 ]; then
            echo '✅ All pods are Ready!'
            exit 0
          fi
          sleep 15
        done

        echo '❌ Pods failed to become Ready in time'
        echo '📋 Final pod list:'
        vagrant ssh -c 'kubectl get pods -A -o wide'
        echo '🧪 Detailed status of unready pods:'
        vagrant ssh -c '
          kubectl get pods -A -o json |
          jq -r "
            .items[] |
            select(.status.containerStatuses[]?.ready != true) |
            \"Namespace: \(.metadata.namespace)\nPod: \(.metadata.name)\nStatus: \(.status.phase)\nReason: \(.status.containerStatuses[]?.state | tojson)\n---\""
        '
        exit 1

    - name: 📡 Check Prometheus Targets
      run: |
        vagrant ssh -c '
          curl -s http://localhost:9090/api/v1/targets | grep "up"
        '

    - name: 🧪 Optional Curl App URLs
      run: |
        vagrant ssh -c '
          curl -s -o /dev/null -w "%{http_code}" http://microfail.kube-lab.local | grep 200
        '
